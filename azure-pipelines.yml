# Starter pipeline

# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- main

pool:
  name: Gethub Enterprise Server   # Use your self-hosted agent pool

variables:
  cliPath: 'C:\WorkBenchCLI_Workspace\topazworkbenchcli.24.1.01.103'
  testScenarioPath: 'C:\runtime\TotalTest-2503\CWK8000_CW01\Tests\Scenarios\CWK8000_Scenario.testscenario'
  configPath: 'C:\runtime\TotalTest-2503\TotalTestConfiguration'
  targetFolder: 'C:\runtime\TotalTest-2503'
  ccRepo: 'PINAKA0.AJAY.CCTEST'
  ccSystem: 'ajay12'
  ccTestId: 'ajay12'
  envId: 'd59115f4-0250-48f4-9c15-450bc236d456'
  userId: 'PINAKA0'
  password: $(bmcPassword)   # Secret variable in pipeline UI

steps:
# ✅ Run TotalTest CLI
- task: CmdLine@2
  displayName: 'Run TotalTest CLI'
  inputs:
    script: |
      "$(cliPath)\TotalTestFTCLI.bat" ^
      -f "$(testScenarioPath)" ^
      -R -g TTTReport -G -v 6 -l CLI -log "All" ^
      -u "$(userId)" -p "$(password)" ^
      -cfgdir "$(configPath)" ^
      -ccrepo "$(ccRepo)" -ccsystem "$(ccSystem)" -cctestid "$(ccTestId)" ^
      -e "$(envId)"

# ✅ Show CLI Log
- task: CmdLine@2
  displayName: 'Show CLI Log'
  inputs:
    script: |
      echo "After CLI execution"
      cd "$(targetFolder)\CWK8000_CW01\Tests\Output"
      dir
      IF EXIST "CWK8000_Scenario.cli.suiteresult" type "CWK8000_Scenario.cli.suiteresult"
      IF EXIST "CWK8000_Scenario.cli.suite.sonar.xml" type "CWK8000_Scenario.cli.suite.sonar.xml"
      IF EXIST "CWK8000_Scenario.cli.suite.junit.xml" type "CWK8000_Scenario.cli.suite.junit.xml"
      IF EXIST "CWK8000_Scenario.cli.sonar.codecoverage.xml" type "CWK8000_Scenario.cli.sonar.codecoverage.xml"

# ✅ Run Code Coverage CLI
- task: CmdLine@2
  displayName: 'Run CodeCoverage CLI'
  inputs:
    script: |
      "$(cliPath)\CodeCoverageCLI.bat" ^
      -host "$(host)" ^
      -port "$(port)" ^
      -code 1047 ^
      -data "$(targetFolder)\target\data\code_coverage" ^
      -cc.test "Test" ^
      -cc.repos "$(ccRepo)" ^
      -cc.system "$(ccSystem)" ^
      -cc.sources "$(cliPath)\sources","$(cliPath)\copyBook" ^
      -targetFolder "$(targetFolder)" ^
      -id "$(userId)" ^
      -pass "$(password)"

# ✅ Verify Coverage File Exists
- task: CmdLine@2
  displayName: 'Verify Coverage File'
  inputs:
    script: |
      echo "Checking coverage file..."
      dir "$(cliPath)\Coverage"
      IF EXIST "$(cliPath)\Coverage\CodeCoverage.xml" (
        echo "Coverage file found."
      ) ELSE (
        echo "Coverage file NOT found!"
      )

# ✅ Publish Code Coverage Results
- task: PublishCodeCoverageResults@2
  displayName: 'Publish Code Coverage Results'
  inputs:
    codeCoverageTool: 'Cobertura'   # Use Cobertura if supported
    summaryFileLocation: 'C:\WorkBenchCLI_Workspace\topazworkbenchcli.24.1.01.103\Coverage\CodeCoverage.xml'
    pathToSources: 'C:\WorkBenchCLI_Workspace\topazworkbenchcli.24.1.01.103\Coverage'
    failIfCoverageEmpty: true